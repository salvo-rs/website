```typescript
import { Tab, Tabs } from '@rspress/core/theme';

# Генерация документации OpenAPI

OpenAPI — это открытая спецификация для описания дизайна интерфейсов RESTful API. Она определяет структуры запросов и ответов API, параметры, типы возвращаемых значений, коды ошибок и другие детали в формате JSON или YAML, делая взаимодействие между клиентом и сервером более явным и стандартизированным.

OpenAPI изначально была открытой версией спецификации Swagger, а теперь стала независимым проектом, поддерживаемым многими крупными компаниями и разработчиками. Использование спецификации OpenAPI помогает командам разработчиков лучше сотрудничать, снижать затраты на коммуникацию и повышать эффективность разработки. Кроме того, OpenAPI предоставляет разработчикам инструменты для автоматической генерации документации API, мок-данных и тестовых сценариев, облегчая работу по разработке и тестированию.

Salvo предоставляет интеграцию с OpenAPI (модифицированную на основе [utoipa](https://github.com/juhaku/utoipa)). Salvo элегантно автоматически извлекает соответствующую информацию о типах данных OpenAPI из `Handler`, основываясь на своих особенностях. Salvo также интегрирует несколько популярных интерфейсов OpenAPI с открытым исходным кодом, таких как SwaggerUI, Scalar, RapiDoc и ReDoc.

Поскольку имена типов в Rust могут быть длинными и не всегда подходящими для использования в OpenAPI, `salvo-oapi` предоставляет тип `Namer`, который позволяет настраивать правила для изменения имён типов в OpenAPI по мере необходимости.

_**Пример кода**_

<Tabs>
<Tab label="main.rs">
```rust file="<root>/codes/oapi-hello/src/main.rs"
```
</Tab>
<Tab label="Cargo.toml">
```toml file="<root>/codes/oapi-hello/Cargo.toml"
```
</Tab>
</Tabs>

Введите `http://localhost:5800/swagger-ui` в браузере, чтобы увидеть страницу Swagger UI.

Интеграция OpenAPI в Salvo довольно элегантна. Для приведённого выше примера, по сравнению с обычным проектом Salvo, мы просто выполнили следующие шаги:

- Включили функцию `oapi` в `Cargo.toml`: `salvo = { workspace = true, features = ["oapi"] }`;

- Заменили `#[handler]` на `#[endpoint]`;

- Использовали `name: QueryParam<String, false>` для получения значения строки запроса. Когда вы посещаете `http://localhost/hello?name=chris`, строка запроса `name` будет разобрана. `false` в `QueryParam<String, false>` означает, что этот параметр является необязательным. Если вы посетите `http://localhost/hello`, ошибки не будет. Напротив, если это `QueryParam<String, true>`, это означает, что параметр должен быть предоставлен, иначе будет возвращена ошибка.

- Создали `OpenAPI` и соответствующий `Router`. `merge_router` в `OpenApi::new("test api", "0.0.1").merge_router(&router)` означает, что этот `OpenAPI` получает необходимую информацию для документации, анализируя определённый маршрут и его подмаршруты. Некоторые `Handler` маршрутов могут не предоставлять информацию для генерации документов, и такие маршруты будут проигнорированы, например, `Handler`, определённые с помощью макроса `#[handler]` вместо макроса `#[endpoint]`. То есть в реальных проектах, по причинам, таким как ход разработки, вы можете выбрать не генерировать документацию OpenAPI или генерировать её частично. Впоследствии вы можете постепенно увеличивать количество генерируемых интерфейсов OpenAPI, и всё, что вам нужно сделать, — это изменить `#[handler]` на `#[endpoint]` и модифицировать сигнатуру функции.

## Извлекатели данных

Вы можете импортировать предустановленные общие извлекатели данных через `use salvo::oapi::extract::*;`. Извлекатель предоставит Salvo некоторую необходимую информацию, чтобы Salvo мог генерировать документы OpenAPI.

- `QueryParam<T, const REQUIRED: bool>`: Извлекатель для извлечения данных из строки запроса. `QueryParam<T, false>` означает, что этот параметр не является обязательным и может быть опущен. `QueryParam<T, true>` означает, что этот параметр обязателен и не может быть опущен. Если он не предоставлен, будет возвращена ошибка;

- `HeaderParam<T, const REQUIRED: bool>`: Извлекатель для извлечения данных из заголовка запроса. `HeaderParam<T, false>` означает, что этот параметр не является обязательным и может быть опущен. `HeaderParam<T, true>` означает, что этот параметр обязателен и не может быть опущен. Если он не предоставлен, будет возвращена ошибка;

- `CookieParam<T, const REQUIRED: bool>`: Извлекатель для извлечения данных из cookie запроса. `CookieParam<T, false>` означает, что этот параметр не является обязательным и может быть опущен. `CookieParam<T, true>` означает, что этот параметр обязателен и не может быть опущен. Если он не предоставлен, будет возвращена ошибка;

- `PathParam<T>`: Извлекатель для извлечения параметров пути из URL запроса. Если этот параметр не существует, сопоставление маршрута не будет успешным, поэтому нет случая, когда он может быть опущен;

- `FormBody<T>`: Извлекает информацию из отправленной формы запроса;

- `JsonBody<T>`: Извлекает информацию из полезной нагрузки в формате JSON, отправленной запросом;

## `#[endpoint]`

При генерации документов OpenAPI необходимо использовать макрос `#[endpoint]` вместо обычного макроса `#[handler]`. Фактически это расширенная версия макроса `#[handler]`.

- Он может получать необходимую информацию для генерации OpenAPI через сигнатуру функции;

- Для информации, которую неудобно предоставлять через сигнатуру, можно напрямую предоставить её, добавляя атрибуты в макрос `#[endpoint]`. Информация, предоставленная таким образом, будет объединена с информацией, полученной через сигнатуру функции. Если есть конфликт, она перезапишет информацию, предоставленную сигнатурой функции.

Вы можете использовать встроенный в Rust атрибут `#[deprecated]`, чтобы пометить Handler устаревшим. Хотя атрибут `#[deprecated]` поддерживает добавление информации, такой как причина устаревания и версия, OpenAPI не поддерживает это, поэтому эта информация будет проигнорирована при генерации OpenAPI.

Часть документационного комментария в коде будет автоматически извлечена для генерации OpenAPI. Первая строка используется для генерации _`summary`_, а весь комментарий будет использоваться для генерации _`description`_.

```rust
/// Это краткое описание операции
///
/// Все строки документационного комментария будут включены в описание операции.
#[endpoint]
fn endpoint() {}
```

## ToSchema

Вы можете использовать `#[derive(ToSchema)]` для определения структур данных:

```rust
#[derive(ToSchema)]
struct Pet {
    id: u64,
    name: String,
}
```

Вы можете использовать `#[salvo(schema(...))]` для определения дополнительных настроек:

- `example = ...` может быть `json!(...)`. `json!(...)` будет разобрано `serde_json::json!` как `serde_json::Value`.

  ```rust
  #[derive(ToSchema)]
  #[salvo(schema(example = json!({"name": "кот Боб", "id": 0})))]
  struct Pet {
      id: u64,
      name: String,
  }
  ```

- `xml(...)` может использоваться для определения свойств объекта Xml:

  ```rust
  #[derive(ToSchema)]
  struct Pet {
      id: u64,
      #[salvo(schema(xml(name = "pet_name", prefix = "u")))]
      name: String,
  }
  ```

## ToParameters

Генерация [параметров пути][path_parameters] из полей структуры.

Это реализация `#[derive]` для трейта [`ToParameters`][to_parameters].

Обычно параметры пути нужно определять в [`#[salvo_oapi::endpoint(...parameters(...))]`][path_parameters] конечной точки. Однако при использовании [`struct`][struct] для определения параметров вышеуказанные шаги могут быть опущены. Тем не менее, если вам нужно дать описание или изменить конфигурацию по умолчанию, то [`примитивные типы`][primitive] и параметры пути [`String`][std_string] или параметры пути в стиле [tuple] всё ещё нужно определять в `parameters(...)`.

Вы можете использовать встроенный в Rust атрибут `#[deprecated]`, чтобы пометить поля устаревшими, что будет отражено в сгенерированной спецификации OpenAPI.

Атрибут `#[deprecated]` поддерживает добавление дополнительной информации, такой как причина устаревания или версия, с которой оно устарело, но OpenAPI не поддерживает это. OpenAPI поддерживает только логическое значение для определения, устарело ли что-то. Хотя вполне возможно объявить устаревание с причиной, например `#[deprecated  = "Есть лучший способ сделать это"]`, эта причина не будет представлена в спецификации OpenAPI.

Документационный комментарий к полю структуры будет использоваться как описание параметра в сгенерированной спецификации OpenAPI.

```rust
#[derive(salvo_oapi::ToParameters, serde::Deserialize)]
struct Query {
    /// Запрос элементов списка дел по имени.
    name: String
}
```

### Атрибуты контейнера ToParameters для `#[salvo(parameters(...))]`

Следующие атрибуты могут использоваться в атрибуте контейнера `#[salvo(parameters(…))]` структуры, производной от `ToParameters`

- `names(...)` Определяет список имён, разделённых запятыми, для безымянных полей структуры, используемых как параметры пути. Поддерживается только для безымянных структур.
- `style = ...` Определяет метод сериализации для всех параметров, заданный [`ParameterStyle`][style]. Значение по умолчанию основано на атрибуте _`parameter_in`_.
- `default_parameter_in = ...` Определяет позицию по умолчанию, используемую параметрами этого поля. Значение этой позиции происходит из [`parameter::ParameterIn`][in_enum]. Если этот атрибут не предоставлен, по умолчанию используется `query`.
- `rename_all = ...` может использоваться как альтернатива `rename_all` от `serde`. Фактически предоставляет ту же функциональность.

Используйте `names` для определения имени для одного безымянного параметра.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id")))]
struct Id(u64);
```

Используйте `names` для определения имён для нескольких безымянных параметров.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id", "name")))]
struct IdAndName(u64, String);
```

### Атрибуты полей ToParameters для `#[salvo(parameter(...))]`

Следующие атрибуты могут использоваться на полях структуры `#[salvo(parameter(...))]`:

- `style = ...` Определяет, как параметры сериализуются с помощью [`ParameterStyle`][style]. Значение по умолчанию основано на атрибуте _`parameter_in`_.

- `parameter_in = ...` Используйте значение из [`parameter::ParameterIn`][in_enum], чтобы определить, где находится этот параметр поля. Если это значение не предоставлено, по умолчанию используется `query`.

- `explode` Определяет, создавать ли новую пару _`parameter=value`_ для каждого параметра в _`object`_ или _`array`_.

- `allow_reserved` Определяет, разрешены ли зарезервированные символы _`:/?#[]@!$&'()*+,;=`_ в значении параметра.

- `example = ...` может быть ссылкой на метод или _`json!(...)`_. Данный пример переопределит любые примеры базового типа параметра.

- `value_type = ...` может использоваться для переопределения типа по умолчанию, используемого полями в спецификации OpenAPI. Это полезно, когда тип по умолчанию не соответствует фактическому типу, например, при использовании сторонних типов, не определённых в [`ToSchema`][to_schema] или [`примитивных` типах][primitive]`. Значением может быть любой тип Rust, который может быть сериализован в JSON при нормальных обстоятельствах, или пользовательский тип, такой как _`Object`_._`Object`_, который будет отображаться как общий объект OpenAPI.

- `inline` Если включено, определение этого типа поля должно происходить из [`ToSchema`][to_schema], и это определение будет встроено.

- `default = ...` может быть ссылкой на метод или _`json!(...)`_.

- `format = ...` может быть вариантом перечисления [`KnownFormat`][known_format] или открытым значением в строковой форме. По умолчанию формат выводится из типа атрибута в соответствии со спецификацией OpenApi.

- `write_only` Определяет, что атрибут используется только для операций **записи** _POST,PUT,PATCH_, а не _GET_.

- `read_only` Определяет, что атрибут используется только для операций **чтения** _GET_, а не _POST,PUT,PATCH_.

- `nullable` Определяет, может ли атрибут быть `null` (обратите внимание, что это отличается от необязательного).

- `required = ...` используется для принудительного указания параметра как обязательного. [См. правила](https://docs.rs/salvo-oapi/latest/salvo_oapi/derive.ToParameters.html#field-nullability-and-required-rules).

- `rename = ...` может использоваться как альтернатива `rename` от `serde`. Фактически предоставляет ту же функциональность.

- `multiple_of = ...` используется для определения кратного значения. Значение параметра считается действительным только тогда, когда значение параметра делится на значение этого ключевого слова и результат является целым числом. Кратное значение должно быть строго больше _`0`_.

- `maximum = ...` используется для определения верхнего предела значения, включая текущее значение.

- `minimum = ...` используется для определения нижнего предела значения, включая текущее значение.

- `exclusive_maximum = ...` используется для определения верхнего предела значения, исключая текущее значение.

- `exclusive_minimum = ...` используется для определения нижнего предела значения, исключая текущее значение.

- `max_length = ...` используется для определения максимальной длины значения типа `string`.

- `min_length = ...` используется для определения минимальной длины значения типа `string`.

- `pattern = ...` используется для определения допустимого регулярного выражения, которому должно соответствовать значение поля. Регулярное выражение использует версию _ECMA-262_.

- `max_items = ...` может использоваться для определения максимального количества элементов, разрешённых в поле типа `array`. Значение должно быть неотрицательным целым числом.

- `min_items = ...` может использоваться для определения минимального количества элементов, разрешённых в поле типа `array`. Значение должно быть неотрицательным целым числом.

- `with_schema = ...` использует ссылку на функцию для создания _`схемы`_ вместо _`схемы`_ по умолчанию. Функция должна удовлетворять определению `fn() -> Into<RefOr<Schema>>`. Она не получает никаких параметров и должна возвращать любое значение, которое может быть преобразовано в `RefOr<Schema>`.

- `additional_properties = ...` используется для определения свободных типов для `map`, таких как [`HashMap`](https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html) и [`BTreeMap`](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Свободные типы позволяют использовать любой тип в значениях карты. Поддерживаемые форматы: _`additional_properties`_ и _`additional_properties = true`_.

#### Правила допустимости null и обязательности полей

Некоторые правила для атрибутов допустимости null и обязательности полей _`ToParameters`_ также могут использоваться для атрибутов полей _`ToSchema`_. [См. правила](https://docs.rs/salvo-oapi/latest/salvo_oapi/derive.ToSchema.html#field-nullability-and-required-rules).

### Частичная поддержка атрибутов `#[serde(...)]`

Производная ToParameters в настоящее время поддерживает некоторые [атрибуты serde][serde attributes]. Эти поддерживаемые атрибуты будут отражены в сгенерированной документации OpenAPI. В настоящее время поддерживаются следующие атрибуты:

- `rename
{/* Auto generated, origin file hash:92932333caa2cef840088509d50af1ef */}