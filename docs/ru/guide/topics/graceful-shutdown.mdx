# Плавное завершение работы

Плавное завершение работы (Graceful Shutdown) — это процесс, при котором сервер при остановке не разрывает все соединения немедленно. Вместо этого он сначала прекращает принимать новые запросы, позволяя текущим запросам завершить обработку в течение достаточного времени перед закрытием службы. Такой подход предотвращает внезапное прерывание запросов, что повышает удобство пользователей и надёжность системы.

Salvo поддерживает плавное завершение работы через метод `handle` структуры `Server`, который получает дескриптор сервера, после чего вызывается метод `stop_graceful` для реализации остановки. После вызова этого метода сервер:

- Прекращает принимать новые запросы на подключение
- Ожидает завершения обработки текущих запросов
- Принудительно закрывает оставшиеся соединения после истечения заданного таймаута (если он указан)

Вот простой пример:

```rust
use salvo_core::prelude::*;

#[tokio::main]
async fn main() {
    let acceptor = TcpListener::new("127.0.0.1:5800").bind().await;
    let server = Server::new(acceptor);
    let handle = server.handle();

    // Плавно завершаем работу сервера
    tokio::spawn(async move {
        tokio::time::sleep(std::time::Duration::from_secs(60)).await;
        handle.stop_graceful(None);
    });
    server.serve(Router::new()).await;
}
```

В приведённом примере:

- `server.handle()` получает дескриптор сервера, который можно использовать для управления его жизненным циклом
- `handle.stop_graceful(None)` инициирует процесс плавного завершения работы, где `None` означает отсутствие таймаута — сервер будет бесконечно ждать завершения всех запросов
- Для установки таймаута можно передать `Some(Duration)`, после истечения которого все оставшиеся соединения будут принудительно закрыты

Этот подход особенно подходит для приложений, развёрнутых в контейнерных средах или на облачных платформах, а также для сценариев, требующих горячего обновления, чтобы гарантировать, что запросы не будут неожиданно прерваны.
{/* Auto generated, origin file hash:046b3113209f454ef7a16224e721cfcb */}