---
title: Библиотеки обработки ошибок в Rust
---

# Библиотеки обработки ошибок в Rust

- [thiserror](https://docs.rs/thiserror/latest/thiserror/) предоставляет удобные производные макросы для пользовательских типов ошибок.

- [snafu](https://docs.rs/snafu/latest/snafu/) — это фреймворк обработки и отчётности об ошибках с контекстом.

- [anyhow](https://docs.rs/anyhow/latest/anyhow/) — гибкая библиотека обработки и отчётности об ошибках.

## thiserror vs snafu

### thiserror

thiserror — это лёгкая библиотека, предоставляющая производные макросы для упрощения определения ошибок.

Особенности:
- Лаконичный синтаксис с минимальным шаблонным кодом
- Подходит для создания библиотек типов ошибок и API
- Обычно используется при создании библиотек для других разработчиков

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum DataError {
    #[error("Ошибка базы данных: {0}")]
    DatabaseError(#[from] sqlx::Error),
    
    #[error("Ошибка валидации: {0}")]
    ValidationError(String),
    
    #[error("Запись не найдена")]
    NotFound,
}
```

### snafu

snafu предоставляет более комплексный фреймворк обработки ошибок с акцентом на контекст ошибок и их цепочки.

Особенности:
- Поощряет добавление более точного контекста ошибок через паттерн "селектора контекста"
- Пропагандирует паттерн "одно перечисление ошибок на модуль"
- Поддерживает как структурные, так и кортежные варианты ошибок
- Встроенная поддержка трассировки стека

```rust
use snafu::{Snafu, ResultExt, Backtrace};

#[derive(Debug, Snafu)]
pub enum Error {
    #[snafu(display("Не удалось прочитать файл конфигурации {filename:?}"))]
    ReadConfig {
        filename: String,
        source: std::io::Error,
        backtrace: Backtrace,
    },
    
    // Также поддерживается кортежный стиль
    #[snafu(display("Ошибка ввода-вывода"))]
    Io(#[snafu(source)] std::io::Error, #[snafu(backtrace)] Backtrace),
}

// Пример селектора контекста
fn read_config(path: &str) -> Result<Config, Error> {
    std::fs::read_to_string(path).context(ReadConfigSnafu { filename: path })?;
    // ...
}
```

### Сравнение

| Особенность | thiserror | snafu |
|-------------|-----------|-------|
| Лаконичность синтаксиса | Более лаконичный | Более многословный |
| Контекст ошибок | Базовая поддержка | Богатые механизмы контекста |
| Подходящий масштаб | Небольшие и средние проекты | Средние и крупные проекты |
| Строк на ошибку | ~2 строки на ошибку | ~5 строк на ошибку |
| Организация ошибок | Обычно одно перечисление ошибок | Поощряет перечисления ошибок на уровне модуля |
| Поддержка трассировки стека | Нет встроенной поддержки | Встроенная поддержка |

**Рекомендации по выбору**:
- **Выбирайте thiserror**, когда нужны простые и понятные типы ошибок, особенно в библиотеках
- **Выбирайте snafu**, когда требуется более структурированная обработка ошибок, особенно в крупных приложениях

## anyhow

anyhow — это библиотека обработки ошибок, отличающаяся от двух предыдущих, ориентированная на приложения, а не на библиотеки.

Особенности:
- Разработана для обработки ошибок в приложениях, а не в библиотеках
- Предоставляет динамический тип `anyhow::Error`, который может содержать любую ошибку, реализующую трейт `Error`
- Упрощает обработку множественных типов ошибок
- Не требует определения пользовательских типов ошибок

```rust
use anyhow::{Context, Result};

fn main() -> Result<()> {
    let config = std::fs::read_to_string("config.json")
        .context("Не удалось прочитать файл конфигурации")?;
        
    let app_config: AppConfig = serde_json::from_str(&config)
        .context("Неверный формат конфигурации")?;
        
    // Использование Result<T> как псевдонима типа для Result<T, anyhow::Error>
    Ok(())
}
```

**anyhow vs thiserror/snafu**:
- anyhow ориентирована на обработку ошибок при быстрой разработке приложений
- thiserror/snafu ориентированы на создание точных иерархий типов ошибок
- anyhow обычно используется в коде приложений
- thiserror/snafu обычно используются в коде библиотек

На практике anyhow и thiserror часто используются вместе: библиотеки используют thiserror для определения точных типов ошибок, а приложения используют anyhow для обработки ошибок из различных источников.
{/* Auto generated, origin file hash:22ecf8c206f01cd4508abe6c2e8be0a6 */}