---
title: Альтернативы аллокаторам памяти в Rust
---

# Jemallocator: альтернатива аллокатору памяти jemalloc для Rust

:::tip
Стандартный аллокатор иногда может не освобождать память своевременно. Рекомендуется использовать [jemallocator](https://docs.rs/tikv-jemallocator/latest/tikv_jemallocator/) в качестве глобального аллокатора вместо стандартного.
:::

[jemallocator](https://docs.rs/tikv-jemallocator/latest/tikv_jemallocator/) — это библиотека, которая линкуется с аллокатором памяти jemalloc. Она предоставляет тип `Jemalloc`, реализующий API аллокатора, который можно установить в качестве `#[global_allocator]`.

`tikv-jemallocator` является преемником `jemallocator`. Эти два крейта идентичны, за исключением названия. Для новых проектов рекомендуется использовать версию с префиксом `tikv-`.

## Экосистема jemalloc

Экосистема поддержки jemalloc состоит из следующих крейтов:

- **tikv-jemalloc-sys**: собирает и линкуется с jemalloc, предоставляя сырые C-биндинги к нему.
- **tikv-jemallocator**: предоставляет тип `Jemalloc`, реализующий трейты `GlobalAlloc` и `Alloc`.
- **tikv-jemalloc-ctl**: высокоуровневая обёртка над API управления и интроспекции jemalloc (семейство функций `mallctl*()` и `MALLCTL NAMESPACE`).

## Использование

### Добавление зависимостей

Чтобы использовать tikv-jemallocator, добавьте его в зависимости:

```toml
[dependencies]

[target.'cfg(not(target_env = "msvc"))'.dependencies]
tikv-jemallocator = "0.5"
```

### Установка в качестве глобального аллокатора

Чтобы установить `tikv_jemallocator::Jemalloc` в качестве глобального аллокатора, добавьте следующий код в ваш проект:

```rust
#[cfg(not(target_env = "msvc"))]
use tikv_jemallocator::Jemalloc;

#[cfg(not(target_env = "msvc"))]
#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;
```

Всё! После определения этой статической переменной jemalloc будет использоваться для всех выделений памяти, запрашиваемых кодом Rust в той же программе.

## Преимущества

jemalloc — это реализация malloc общего назначения, ориентированная на:

- Снижение фрагментации памяти
- Масштабируемость в высоконагруженных сценариях
- Предоставление богатых возможностей интроспекции и управления

Особенно полезен в следующих сценариях:
- Долгоживущие приложения
- Нагрузки, интенсивно использующие память
- Высокопроизводительные сервисы, требующие детального управления памятью

## Примечания по совместимости

jemalloc не поддерживает целевую среду MSVC, поэтому недоступен при использовании инструментария MSVC в Windows. Именно поэтому в примерах кода используется условие `cfg(not(target_env = "msvc"))`.
{/* 本行由工具自动生成,原文哈希值:97d5bd2f5d44a1facae329972bdc937f */}