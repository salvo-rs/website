# Плавное завершение работы

Плавное завершение работы означает, что при остановке сервера соединения не разрываются немедленно. Вместо этого сервер сначала перестаёт принимать новые запросы, позволяя уже принятым запросам завершить обработку перед окончательным отключением службы. Такой подход предотвращает внезапное прерывание запросов, повышая удобство пользователей и надёжность системы.

Salvo поддерживает плавное завершение работы через получение дескриптора сервера методом `handle` структуры `Server` с последующим вызовом метода `stop_graceful`. После вызова этого метода сервер:

- Прекращает приём новых подключений
- Ожидает завершения обработки текущих запросов
- Принудительно закрывает оставшиеся соединения по истечении заданного таймаута (если он указан)

Вот простой пример:

```rust
use salvo_core::prelude::*;

#[tokio::main]
async fn main() {
    let acceptor = TcpListener::new("127.0.0.1:5800").bind().await;
    let server = Server::new(acceptor);
    let handle = server.handle();

    // Плавное завершение работы сервера
    tokio::spawn(async move {
        tokio::time::sleep(std::time::Duration::from_secs(60)).await;
        handle.stop_graceful(None);
    });
    server.serve(Router::new()).await;
}
```

В приведённом примере:

- `server.handle()` получает дескриптор сервера для управления его жизненным циклом
- `handle.stop_graceful(None)` инициирует процесс плавного завершения работы. `None` означает отсутствие таймаута — сервер будет ждать завершения всех запросов
- Для установки таймаута можно передать `Some(Duration)`, после чего оставшиеся соединения будут принудительно закрыты

Этот подход особенно полезен для приложений, развёртываемых в контейнерах или облачных платформах, а также при необходимости обновления "на лету" без неожиданного прерывания запросов.
{/* 本行由工具自动生成,原文哈希值:37a3d8a11c033b0d07dca20cf5f3b96b */}