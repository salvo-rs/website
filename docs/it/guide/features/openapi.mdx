import { Tab, Tabs } from '@rspress/core/theme';

# Generazione della documentazione OpenAPI

OpenAPI è una specifica open source utilizzata per descrivere la progettazione delle interfacce delle API RESTful. Definisce in formato JSON o YAML la struttura delle richieste e delle risposte dell'API, i parametri, i tipi di ritorno, i codici di errore e altri dettagli, rendendo la comunicazione tra client e server più chiara e standardizzata.

OpenAPI era inizialmente la versione open source della specifica Swagger, ma ora è diventato un progetto indipendente, supportato da molte grandi aziende e sviluppatori. L'uso della specifica OpenAPI può aiutare i team di sviluppo a collaborare meglio, ridurre i costi di comunicazione e aumentare l'efficienza dello sviluppo. Allo stesso tempo, OpenAPI fornisce agli sviluppatori strumenti per generare automaticamente documentazione API, dati mock e casi di test, facilitando lo sviluppo e i test.

Salvo offre un'integrazione OpenAPI (modificata da [utoipa](https://github.com/juhaku/utoipa)). In base alle sue caratteristiche, Salvo estrae in modo molto elegante le informazioni sui tipi di dati OpenAPI rilevanti direttamente dagli `Handler`. Salvo integra anche diverse interfacce OpenAPI open source popolari come SwaggerUI, scalar, rapidodc e redoc.

Poiché i nomi dei tipi Rust possono essere lunghi e non sempre adatti all'uso in OpenAPI, `salvo-oapi` fornisce il tipo `Namer`, che consente di definire regole personalizzate per modificare i nomi dei tipi in OpenAPI secondo necessità.

_**Codice di esempio**_

<Tabs>
  <Tab label="main.rs">
  ```rust file="<root>/codes/oapi-hello/src/main.rs"
  ```
  </Tab>
  <Tab label="Cargo.toml">
  ```toml file="<root>/codes/oapi-hello/Cargo.toml"
  ```
  </Tab>
</Tabs>

Digitando `http://localhost:5800/swagger-ui` nel browser, è possibile visualizzare la pagina Swagger UI.

L'integrazione OpenAPI in Salvo è piuttosto elegante. Per l'esempio sopra, rispetto a un normale progetto Salvo, abbiamo solo eseguito i seguenti passaggi:

- Abilitare la funzionalità `oapi` in `Cargo.toml`: `salvo = { workspace = true, features = ["oapi"] }`;

- Sostituire `#[handler]` con `#[endpoint]`;

- Utilizzare `name: QueryParam<String, false>` per ottenere il valore della stringa di query. Quando si visita l'URL `http://localhost/hello?name=chris`, questa stringa di query `name` verrà analizzata. Il `false` in `QueryParam<String, false>` indica che questo parametro è opzionale; visitando `http://localhost/hello` non si verificherà alcun errore. Al contrario, `QueryParam<String, true>` indica che questo parametro è obbligatorio; se non fornito, verrà restituito un errore.

- Creare `OpenAPI` e il corrispondente `Router`. `OpenApi::new("test api", "0.0.1").merge_router(&router)`: qui `merge_router` indica che questo `OpenAPI` ottiene le informazioni necessarie per la documentazione analizzando un determinato router e i suoi router discendenti. Alcuni `Handler` dei router potrebbero non fornire informazioni per generare la documentazione; questi router verranno ignorati, ad esempio `Handler` definiti con la macro `#[handler]` invece che con `#[endpoint]`. Ciò significa che in progetti reali, per motivi di tempistiche di sviluppo, è possibile scegliere di non generare documentazione OpenAPI o generarla solo parzialmente. Successivamente, è possibile aumentare gradualmente il numero di interfacce OpenAPI generate, e tutto ciò che serve è cambiare `#[handler]` in `#[endpoint]` e modificare la firma della funzione.

## Estrattori di dati

Tramite `use salvo::oapi::extract::*;` è possibile importare estrattori di dati predefiniti comunemente utilizzati. Gli estrattori forniscono a Salvo alcune informazioni necessarie per generare la documentazione OpenAPI.

- `QueryParam<T, const REQUIRED: bool>`: un estrattore che recupera dati dalla stringa di query. `QueryParam<T, false>` indica che questo parametro non è obbligatorio e può essere omesso. `QueryParam<T, true>` indica che questo parametro è obbligatorio e non può essere omesso; se non fornito, verrà restituito un errore.

- `HeaderParam<T, const REQUIRED: bool>`: un estrattore che recupera dati dalle intestazioni della richiesta. `HeaderParam<T, false>` indica che questo parametro non è obbligatorio e può essere omesso. `HeaderParam<T, true>` indica che questo parametro è obbligatorio e non può essere omesso; se non fornito, verrà restituito un errore.

- `CookieParam<T, const REQUIRED: bool>`: un estrattore che recupera dati dai cookie della richiesta. `CookieParam<T, false>` indica che questo parametro non è obbligatorio e può essere omesso. `CookieParam<T, true>` indica che questo parametro è obbligatorio e non può essere omesso; se non fornito, verrà restituito un errore.

- `PathParam<T>`: un estrattore che recupera i parametri del percorso dall'`URL` della richiesta. Se questo parametro non esiste, la corrispondenza del percorso non ha successo, quindi non esiste la possibilità di ometterlo.

- `FormBody<T>`: recupera informazioni dal modulo inviato nella richiesta.

- `JsonBody<T>`: recupera informazioni dal payload in formato JSON inviato nella richiesta.

## `#[endpoint]`

Quando si genera la documentazione OpenAPI, è necessario utilizzare la macro `#[endpoint]` al posto della consueta macro `#[handler]`. In realtà, è una versione potenziata della macro `#[handler]`.

- Può ottenere le informazioni necessarie per generare OpenAPI dalla firma della funzione.

- Per le informazioni che non è conveniente fornire tramite la firma, è possibile fornirle direttamente aggiungendo attributi nella macro `#[endpoint]`. Le informazioni fornite in questo modo verranno unite a quelle ottenute dalla firma della funzione; in caso di conflitto, sovrascriveranno le informazioni fornite dalla firma.

È possibile utilizzare l'attributo `#[deprecated]` integrato in Rust per contrassegnare un determinato Handler come obsoleto e deprecato. Sebbene l'attributo `#[deprecated]` supporti l'aggiunta di informazioni come motivo di deprecazione o versione, OpenAPI non le supporta, quindi queste informazioni verranno ignorate durante la generazione di OpenAPI.

I commenti di documentazione nel codice vengono automaticamente estratti per generare OpenAPI. La prima riga viene utilizzata per generare il _`summary`_, mentre l'intera parte del commento viene utilizzata per generare la _`description`_.

```rust
/// Questo è un riepilogo dell'operazione
///
/// Tutte le righe del commento di documentazione saranno incluse nella descrizione dell'operazione.
#[endpoint]
fn endpoint() {}
```

## ToSchema

È possibile definire strutture di dati utilizzando `#[derive(ToSchema)]`:

```rust
#[derive(ToSchema)]
struct Pet {
    id: u64,
    name: String,
}
```

È possibile definire impostazioni opzionali utilizzando `#[salvo(schema(...))]`:

- `example = ...` può essere `json!(...)`. `json!(...)` verrà analizzato da `serde_json::json!` come `serde_json::Value`.

  ```rust
  #[derive(ToSchema)]
  #[salvo(schema(example = json!({"name": "bob the cat", "id": 0})))]
  struct Pet {
      id: u64,
      name: String,
  }
  ```

- `xml(...)` può essere utilizzato per definire le proprietà dell'oggetto Xml:

  ```rust
  #[derive(ToSchema)]
  struct Pet {
      id: u64,
      #[salvo(schema(xml(name = "pet_name", prefix = "u")))]
      name: String,
  }
  ```

## ToParameters

Genera [parametri di percorso][path_parameters] dai campi di una struttura.

Questa è l'implementazione `#[derive]` del tratto [`ToParameters`][to_parameters].

Normalmente, i parametri di percorso devono essere definiti in [`#[salvo_oapi::endpoint(...parameters(...))]`][path_parameters] dell'`endpoint`. Tuttavia, quando si utilizza una [`struct`][struct] per definire i parametri, questo passaggio può essere omesso. Tuttavia, se è necessario fornire una descrizione o modificare la configurazione predefinita, i parametri di percorso di tipo [`primitive types`][primitive] e [`String`][std_string] o i parametri di percorso in stile [tuple] devono ancora essere definiti in `parameters(...)`.

È possibile utilizzare l'attributo `#[deprecated]` integrato in Rust per contrassegnare un campo come deprecato, e questo si rifletterà nella specifica OpenAPI generata.

L'attributo `#[deprecated]` supporta l'aggiunta di informazioni aggiuntive come il motivo della deprecazione o la versione da cui è deprecato, ma OpenAPI non le supporta. OpenAPI supporta solo un valore booleano per determinare se è deprecato. Sebbene sia possibile dichiarare una deprecazione con un motivo, come `#[deprecated  = "There is better way to do this"]`, questo motivo non verrà presentato nella specifica OpenAPI.

I commenti di documentazione sui campi della struttura verranno utilizzati come descrizione dei parametri nella specifica OpenAPI generata.

```rust
#[derive(salvo_oapi::ToParameters, serde::Deserialize)]
struct Query {
    /// Query degli elementi todo per nome.
    name: String
}
```

### Attributi del Contenitore ToParameters per `#[salvo(parameters(...))]`

I seguenti attributi possono essere utilizzati nell'attributo contenitore `#[salvo(parameters(…))]` delle strutture che derivano da `ToParameters`:

- `names(...)` definisce un elenco di nomi separati da virgole per i campi senza nome della struttura utilizzati come parametri di percorso. Supportato solo su strutture senza nome.
- `style = ...` può definire come vengono serializzati tutti i parametri, specificato da [`ParameterStyle`][style]. Il valore predefinito si basa sull'attributo _`parameter_in`_.
- `default_parameter_in = ...` definisce la posizione predefinita utilizzata per i parametri di questo campo, il cui valore proviene da [`parameter::ParameterIn`][in_enum]. Se non fornito, il valore predefinito è `query`.
- `rename_all = ...` può essere utilizzato come alternativa a `rename_all` di `serde`. Fornisce essenzialmente la stessa funzionalità.

Utilizzare `names` per definire un nome per un singolo parametro senza nome.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id")))]
struct Id(u64);
```

Utilizzare `names` per definire nomi per più parametri senza nome.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id", "name")))]
struct IdAndName(u64, String);
```

### Attributi dei Campi ToParameters per `#[salvo(parameter(...))]`

I seguenti attributi possono essere utilizzati sui campi della struttura con `#[salvo(parameter(...))]`:

- `style = ...` definisce come il parametro viene serializzato da [`ParameterStyle`][style]. Il valore predefinito si basa sull'attributo _`parameter_in`_.

- `parameter_in = ...` definisce dove si trova il parametro di questo campo utilizzando un valore da [`parameter::ParameterIn`][in_enum]. Se non fornito, il valore predefinito è `query`.

- `explode` definisce se creare una nuova coppia _`parameter=value`_ per ogni parametro in un _`object`_ o _`array`_.

- `allow_reserved` definisce se i caratteri riservati _`:/?#[]@!$&'()*+,;=`_ sono consentiti nel valore del parametro.

- `example = ...` può essere un riferimento a un metodo o _`json!(...)`_. L'esempio fornito sovrascriverà qualsiasi esempio del tipo di parametro sottostante.

- `value_type = ...` può essere utilizzato per sovrascrivere il tipo predefinito utilizzato per il campo nella specifica OpenAPI. Utile quando il tipo predefinito non corrisponde al tipo effettivo, ad esempio quando si utilizzano tipi di terze parti non definiti in [`ToSchema`][to_schema] o nei tipi [`primitive`][primitive]. Il valore può essere qualsiasi tipo Rust che normalmente può essere serializzato in JSON o un tipo personalizzato come _`Object`_. _`Object`_ verrà renderizzato come un oggetto OpenAPI generico.

- `inline` se abilitato, la definizione del tipo di questo campo deve provenire da [`ToSchema`][to_schema] e questa definizione verrà inclusa in linea.

- `default = ...` può essere un riferimento a un metodo o _`json!(...)`_.

- `format = ...` può essere una variante dell'enumerazione [`KnownFormat`][known_format] o un valore aperto in formato stringa. Per impostazione predefinita, il formato è dedotto dal tipo della proprietà secondo la specifica OpenAPI.

- `write_only` definisce che la proprietà è utilizzata solo per operazioni di **scrittura** _POST,PUT,PATCH_ e non per _GET_.

- `read_only` definisce che la proprietà è utilizzata solo per operazioni di **lettura** _GET_ e non per _POST,PUT,PATCH_.

- `nullable` definisce se la proprietà può essere `null` (nota: questo è diverso dall'essere non obbligatoria).

- `required = ...` utilizzato per forzare l'obbligatorietà del parametro. [Vedere le regole](https://docs.rs/salvo-oapi/latest/salvo_oapi/derive.ToParameters.html#field-nullability-and-required-rules).

- `rename = ...` può essere utilizzato come alternativa a `rename` di `serde`. Fornisce essenzialmente la stessa funzionalità.

- `multiple_of = ...` utilizzato per definire un multiplo del valore. Un valore di parametro è considerato valido solo se diviso per il valore di questa parola chiave produce un numero intero. Il valore del multiplo deve essere strettamente maggiore di _`0`_.

- `maximum = ...` utilizzato per definire un limite superiore per il valore, inclusivo del valore stesso.

- `minimum = ...` utilizzato per definire un limite inferiore per il valore, inclusivo del valore stesso.

- `exclusive_maximum = ...` utilizzato per definire un limite superiore per il valore, esclusivo del valore stesso.

- `exclusive_minimum = ...` utilizzato per definire un limite inferiore per il valore, esclusivo del valore stesso.

- `max_length = ...` utilizzato per definire la lunghezza massima per i valori di tipo `string`.

- `min_length = ...` utilizzato per definire la lunghezza minima per i valori di tipo `string`.

- `pattern = ...` utilizzato per definire un'espressione regolare valida che il valore del campo deve corrispondere, l'espressione regolare segue la versione _ECMA-262_.

- `max_items = ...` può essere utilizzato per definire il numero massimo di elementi consentiti per un campo di tipo `array`. Il valore deve essere un intero non negativo.

- `min_items = ...` può essere utilizzato per definire il numero minimo di elementi consentiti per un campo di tipo `array`. Il valore deve essere un intero non negativo.

- `with_schema = ...` utilizza uno _`schema`_ creato da un riferimento a funzione invece dello _`schema`_ predefinito. La funzione deve soddisfare la definizione `fn() -> Into<RefOr<Schema>>`. Non accetta parametri e deve restituire qualsiasi valore che possa essere convertito in `RefOr<Schema>`.

- `additional_properties = ...` utilizzato per definire un tipo a forma libera per le `map`, come [`HashMap`](https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html) e [`BTreeMap`](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Il tipo a forma libera consente l'uso di tipi arbitrari nei valori della mappa. I formati supportati sono _`additional_properties`_ e _`additional_properties = true`_.

#### Regole di nullabilità e obbligatorietà dei campi

Alcune regole di nullabilità e obbligatorietà applicate agli attributi dei campi _`ToParameters`_ sono le stesse utilizzate per gli attributi dei campi _`ToSchema`_. [Vedere le regole](https://docs.rs/salvo-oapi/latest/salvo_oapi/derive.ToSchema.html#field
{/* 本行由工具自动生成,原文哈希值:0cd338da7f2e4cf2b5d77a3752808958 */}