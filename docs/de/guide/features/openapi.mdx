import { Tab, Tabs } from '@rspress/core/theme';

# OpenAPI-Dokumentationsgenerierung

OpenAPI ist eine Open-Source-Spezifikation zur Beschreibung von RESTful-API-Schnittstellen. Es definiert die Struktur von Anfragen und Antworten, Parameter, Rückgabetypen, Fehlercodes und andere Details im JSON- oder YAML-Format, wodurch die Kommunikation zwischen Client und Server klarer und standardisierter wird.

OpenAPI war ursprünglich die Open-Source-Version der Swagger-Spezifikation und ist nun ein eigenständiges Projekt, das von vielen großen Unternehmen und Entwicklern unterstützt wird. Die Verwendung der OpenAPI-Spezifikation kann Entwicklungsteams bei der besseren Zusammenarbeit helfen, Kommunikationskosten reduzieren und die Entwicklungseffizienz steigern. Gleichzeitig bietet OpenAPI Entwicklern Tools zur automatischen Generierung von API-Dokumentation, Mock-Daten und Testfällen, was Entwicklungs- und Testarbeiten erleichtert.

Salvo bietet eine Integration von OpenAPI (modifiziert von [utoipa](https://github.com/juhaku/utoipa)). Salvo holt sich sehr elegant automatisch relevante OpenAPI-Datentypinformationen von `Handler` basierend auf seinen eigenen Eigenschaften. Salvo integriert auch mehrere beliebte OpenAPI-Oberflächen wie SwaggerUI, scalar, rapidodc und redoc.

Da Rust-Typnamen oft lang sind und nicht unbedingt für OpenAPI geeignet sind, bietet `salvo-oapi` den Typ `Namer`, mit dem Sie Regeln anpassen und die Typnamen in OpenAPI nach Bedarf ändern können.

_**Beispielcode**_

<Tabs>
  <Tab label="main.rs">
  ```rust file="<root>/codes/oapi-hello/src/main.rs"
  ```
  </Tab>
  <Tab label="Cargo.toml">
  ```toml file="<root>/codes/oapi-hello/Cargo.toml"
  ```
  </Tab>
</Tabs>

Geben Sie `http://localhost:5800/swagger-ui` in Ihren Browser ein, um die Swagger UI-Seite zu sehen.

Die OpenAPI-Integration in Salvo ist recht elegant. Im Vergleich zu einem normalen Salvo-Projekt haben wir für das obige Beispiel nur die folgenden Schritte durchgeführt:

- Aktivieren Sie die `oapi`-Funktion in `Cargo.toml`: `salvo = { workspace = true, features = ["oapi"] }`;

- Ersetzen Sie `[handler]` durch `[endpoint]`;

- Verwenden Sie `name: QueryParam<String, false>`, um den Wert der Abfragezeichenfolge zu erhalten. Wenn Sie die URL `http://localhost/hello?name=chris` aufrufen, wird diese `name`-Abfragezeichenfolge analysiert. Das `false` in `QueryParam<String, false>` bedeutet, dass dieser Parameter optional ist. Wenn Sie `http://localhost/hello` aufrufen, tritt kein Fehler auf. Im Gegensatz dazu bedeutet `QueryParam<String, true>`, dass dieser Parameter erforderlich ist, andernfalls wird ein Fehler zurückgegeben.

- Erstellen Sie `OpenAPI` und den entsprechenden `Router`. `OpenApi::new("test api", "0.0.1").merge_router(&router)` – hier bedeutet `merge_router`, dass dieses `OpenAPI` die notwendigen Dokumentationsinformationen erhält, indem es einen bestimmten Router und seine Unterrouter analysiert. Einige `Handler` von Routern bieten möglicherweise keine Informationen zur Dokumentationsgenerierung. Diese Router werden ignoriert, z.B. `Handler`, die mit dem `#[handler]`-Makro und nicht mit dem `#[endpoint]`-Makro definiert wurden. Das heißt, in realen Projekten können Sie je nach Entwicklungsfortschritt wählen, keine OpenAPI-Dokumentation oder nur teilweise OpenAPI-Dokumentation zu generieren. Später können Sie schrittweise die Anzahl der OpenAPI-Schnittstellen erhöhen, die generiert werden. Alles, was Sie tun müssen, ist, `#[handler]` in `#[endpoint]` zu ändern und die Funktionssignatur anzupassen.

## Datenextraktoren

Durch `use salvo::oapi::extract::*;` können vordefinierte, häufig verwendete Datenextraktoren importiert werden. Die Extraktoren stellen Salvo einige notwendige Informationen zur Verfügung, damit Salvo die OpenAPI-Dokumentation generieren kann.

- `QueryParam<T, const REQUIRED: bool>`: Ein Extraktor, der Daten aus der Abfragezeichenfolge extrahiert. `QueryParam<T, false>` bedeutet, dass dieser Parameter optional ist. `QueryParam<T, true>` bedeutet, dass dieser Parameter erforderlich ist und nicht weggelassen werden darf. Wenn er nicht bereitgestellt wird, wird ein Fehler zurückgegeben.

- `HeaderParam<T, const REQUIRED: bool>`: Ein Extraktor, der Daten aus den Header-Informationen der Anfrage extrahiert. `HeaderParam<T, false>` bedeutet, dass dieser Parameter optional ist. `HeaderParam<T, true>` bedeutet, dass dieser Parameter erforderlich ist und nicht weggelassen werden darf. Wenn er nicht bereitgestellt wird, wird ein Fehler zurückgegeben.

- `CookieParam<T, const REQUIRED: bool>`: Ein Extraktor, der Daten aus den Cookie-Informationen der Anfrage extrahiert. `CookieParam<T, false>` bedeutet, dass dieser Parameter optional ist. `CookieParam<T, true>` bedeutet, dass dieser Parameter erforderlich ist und nicht weggelassen werden darf. Wenn er nicht bereitgestellt wird, wird ein Fehler zurückgegeben.

- `PathParam<T>`: Ein Extraktor, der Pfadparameter aus der Anfrage-`URL` extrahiert. Wenn dieser Parameter nicht existiert, ist das Routing nicht erfolgreich, daher gibt es keine Situation, in der er weggelassen werden kann.

- `FormBody<T>`: Extrahiert Informationen aus dem übermittelten Formular der Anfrage.

- `JsonBody<T>`: Extrahiert Informationen aus der JSON-formatierten Nutzlast der Anfrage.

## `#[endpoint]`

Bei der Generierung von OpenAPI-Dokumentation muss das `#[endpoint]`-Makro anstelle des üblichen `#[handler]`-Makros verwendet werden. Es handelt sich tatsächlich um eine erweiterte Version des `#[handler]`-Makros.

- Es kann die für die OpenAPI-Generierung notwendigen Informationen aus der Funktionssignatur abrufen.

- Für Informationen, die nicht bequem über die Signatur bereitgestellt werden können, können sie direkt als Attribute im `#[endpoint]`-Makro hinzugefügt werden. Auf diese Weise bereitgestellte Informationen werden mit den aus der Funktionssignatur abgerufenen Informationen zusammengeführt. Bei Konflikten überschreiben sie die aus der Signatur bereitgestellten Informationen.

Sie können das integrierte Rust-Attribut `#[deprecated]` verwenden, um einen Handler als veraltet und überholt zu kennzeichnen. Obwohl das `#[deprecated]`-Attribut das Hinzufügen von Informationen wie Verfallsgrund oder Version unterstützt, unterstützt OpenAPI diese nicht, daher werden diese Informationen bei der OpenAPI-Generierung ignoriert.

Die Dokumentationskommentare im Code werden automatisch für die OpenAPI-Generierung extrahiert. Die erste Zeile wird für die _`summary`_ verwendet, der gesamte Kommentarteil wird für die _`description`_ verwendet.

```rust
/// Dies ist eine Zusammenfassung des Vorgangs
///
/// Alle Zeilen des Dokumentationskommentars werden in die Vorgangsbeschreibung aufgenommen.
#[endpoint]
fn endpoint() {}
```

## ToSchema

Sie können Datenstrukturen mit `#[derive(ToSchema)]` definieren:

```rust
#[derive(ToSchema)]
struct Pet {
    id: u64,
    name: String,
}
```

Sie können optionale Einstellungen mit `#[salvo(schema(...))]` definieren:

- `example = ...` kann `json!(...)` sein. `json!(...)` wird von `serde_json::json!` als `serde_json::Value` geparst.

  ```rust
  #[derive(ToSchema)]
  #[salvo(schema(example = json!({"name": "bob the cat", "id": 0})))]
  struct Pet {
      id: u64,
      name: String,
  }
  ```

- `xml(...)` kann verwendet werden, um Xml-Objektattribute zu definieren:

  ```rust
  #[derive(ToSchema)]
  struct Pet {
      id: u64,
      #[salvo(schema(xml(name = "pet_name", prefix = "u")))]
      name: String,
  }
  ```

## ToParameters

Generiert [Pfadparameter][path_parameters] aus den Feldern einer Struktur.

Dies ist eine `#[derive]`-Implementierung des [`ToParameters`][to_parameters]-Traits.

Normalerweise müssen Pfadparameter im [`#[salvo_oapi::endpoint(...parameters(...))]`][path_parameters] des `endpoint` definiert werden. Wenn jedoch eine [`struct`][struct] zur Parameterdefinition verwendet wird, kann dieser Schritt übersprungen werden. Nichtsdestotrotz müssen [`primitive types`][primitive] und [`String`][std_string]-Pfadparameter oder [tuple]-stilige Pfadparameter in `parameters(...)` definiert werden, wenn Beschreibungen angegeben oder Standardeinstellungen geändert werden müssen.

Sie können das integrierte Rust-Attribut `#[deprecated]` verwenden, um ein Feld als veraltet zu markieren, was sich in der generierten OpenAPI-Spezifikation widerspiegelt.

Das `#[deprecated]`-Attribut unterstützt das Hinzufügen zusätzlicher Informationen wie Verfallsgrund oder ab welcher Version es veraltet ist, aber OpenAPI unterstützt dies nicht. OpenAPI unterstützt nur einen booleschen Wert, um zu bestimmen, ob etwas veraltet ist. Obwohl es durchaus möglich ist, eine Veraltung mit Grund zu deklarieren, z.B. `#[deprecated  = "There is better way to do this"]`, wird dieser Grund nicht in der OpenAPI-Spezifikation dargestellt.

Dokumentationskommentare auf Strukturfeldern werden als Parameterbeschreibung in der generierten OpenAPI-Spezifikation verwendet.

```rust
#[derive(salvo_oapi::ToParameters, serde::Deserialize)]
struct Query {
    /// Todo-Elemente nach Namen abfragen.
    name: String
}
```

### ToParameters Container-Attribute für `#[salvo(parameters(...))]`

Die folgenden Attribute können in den Container-Attributen `#[salvo(parameters(…))]` von Strukturen verwendet werden, die von `ToParameters` abgeleitet sind:

- `names(...)` definiert eine durch Kommas getrennte Liste von Namen für unbenannte Felder der Struktur, die als Pfadparameter verwendet werden. Wird nur für unbenannte Strukturen unterstützt.
- `style = ...` kann den Serialisierungsstil für alle Parameter definieren, angegeben durch [`ParameterStyle`][style]. Der Standardwert basiert auf dem _`parameter_in`_-Attribut.
- `default_parameter_in = ...` definiert die Standardposition, die für Parameter dieses Felds verwendet wird, wobei der Wert aus [`parameter::ParameterIn`][in_enum] stammt. Wenn dieses Attribut nicht angegeben wird, lautet der Standard `query`.
- `rename_all = ...` kann als Alternative zu `serde`s `rename_all` dienen. Bietet im Wesentlichen die gleiche Funktionalität.

Verwenden Sie `names`, um einem einzelnen unbenannten Parameter einen Namen zu geben.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id")))]
struct Id(u64);
```

Verwenden Sie `names`, um mehreren unbenannten Parametern Namen zu geben.

```rust
# use salvo_oapi::ToParameters;

#[derive(ToParameters, serde::Deserialize)]
#[salvo(parameters(names("id", "name")))]
struct IdAndName(u64, String);
```

### ToParameters Feld-Attribute für `#[salvo(parameter(...))]`

Die folgenden Attribute können auf Strukturfeldern mit `#[salvo(parameter(...))]` verwendet werden:

- `style = ...` definiert, wie der Parameter durch [`ParameterStyle`][style] serialisiert wird. Der Standardwert basiert auf dem _`parameter_in`_-Attribut.

- `parameter_in = ...` definiert mit einem Wert aus [`parameter::ParameterIn`][in_enum], wo sich dieser Feldparameter befindet. Wenn dieser Wert nicht angegeben wird, lautet der Standard `query`.

- `explode` definiert, ob für jeden Parameter in einem _`object`_ oder _`array`_ ein neues _`parameter=value`_-Paar erstellt wird.

- `allow_reserved` definiert, ob reservierte Zeichen _`:/?#[]@!$&'()*+,;=`_ in Parameterwerten erlaubt sind.

- `example = ...` kann ein Methodenverweis oder _`json!(...)`_ sein. Das angegebene Beispiel überschreibt alle Beispiele des zugrunde liegenden Parametertyps.

- `value_type = ...` kann verwendet werden, um den Standardtyp, der für das Feld in der OpenAPI-Spezifikation verwendet wird, zu überschreiben. Nützlich, wenn der Standardtyp nicht dem tatsächlichen Typ entspricht, z.B. bei der Verwendung von Drittanbietertypen, die nicht in [`ToSchema`][to_schema] oder [`primitive` types][primitive] definiert sind. Der Wert kann ein beliebiger Rust-Typ sein, der normalerweise in JSON serialisiert werden kann, oder ein benutzerdefinierter Typ wie _`Object`_. _`Object`_ wird als generisches OpenAPI-Objekt gerendert.

- `inline` wenn aktiviert, muss die Definition dieses Feldtyps von [`ToSchema`][to_schema] stammen, und diese Definition wird inline gesetzt.

- `default = ...` kann ein Methodenverweis oder _`json!(...)`_ sein.

- `format = ...` kann eine Variante der [`KnownFormat`][known_format]-Enumeration oder ein offener Zeichenkettenwert sein. Standardmäßig wird das Format basierend auf dem Typ der Eigenschaft gemäß der OpenAPI-Spezifikation abgeleitet.

- `write_only` definiert, dass die Eigenschaft nur für **Schreib**operationen _POST,PUT,PATCH_ und nicht für _GET_ verwendet wird.

- `read_only` definiert, dass die Eigenschaft nur für **Lese**operationen _GET_ und nicht für _POST,PUT,PATCH_ verwendet wird.

- `nullable` definiert, ob die Eigenschaft `null` sein kann (beachten Sie, dass dies sich von nicht erforderlich unterscheidet).

- `required = ...` wird verwendet, um zu erzwingen, dass ein Parameter erforderlich ist. [Siehe Regeln](https://docs.rs/salvo-oapi/latest/salvo_oapi/derive.ToParameters.html#field-nullability-and-required-rules).

- `rename = ...` kann als Alternative zu `serde`s `rename` dienen. Bietet im Wesentlichen die gleiche Funktionalität.

- `multiple_of = ...` wird verwendet, um ein Vielfaches des Werts zu definieren. Ein Parameterwert gilt nur dann als gültig, wenn er durch den mit diesem Schlüsselwort angegebenen Wert geteilt wird und das Ergebnis eine ganze Zahl ist. Der Vielfachwert muss strikt größer als _`0`_ sein.

- `maximum = ...` wird verwendet, um eine Obergrenze für den Wert inklusive des aktuellen Werts zu definieren.

- `minimum = ...` wird verwendet, um eine Untergrenze für den Wert inklusive des aktuellen Werts zu definieren.

- `exclusive_maximum = ...` wird verwendet, um eine Obergrenze für den Wert exklusive des aktuellen Werts zu definieren.

- `exclusive_minimum = ...` wird verwendet, um eine Untergrenze für den Wert exklusive des aktuellen Werts zu definieren.

- `max_length = ...` wird verwendet, um die maximale Länge für `string`-Typwerte zu definieren.

- `min_length = ...` wird verwendet, um die minimale Länge für `string`-Typwerte zu definieren.

- `pattern = ...` wird verwendet, um einen gültigen regulären Ausdruck zu definieren, dem der Feldwert entsprechen muss. Der reguläre Ausdruck verwendet die _ECMA-262_-Version.

- `max_items = ...` kann verwendet werden, um die maximale Anzahl von Elementen zu definieren, die für ein Feld vom Typ `array` erlaubt sind. Der Wert muss eine nicht-negative Ganzzahl sein.

- `min_items = ...` kann verwendet werden, um die minimale Anzahl von Elementen zu definieren, die für ein Feld vom Typ `array` erlaubt sind. Der Wert muss eine nicht-negative Ganzzahl sein.

- `with_schema = ...` verwendet ein durch eine Funktionsreferenz erstelltes _`schema`_ anstelle des Standard-_`schema`_. Die Funktion muss die Signatur `fn() -> Into<RefOr<Schema>>` haben. Sie nimmt keine Parameter entgegen und muss einen Wert zurückgeben, der in `RefOr<Schema>` konvertiert werden kann.

- `additional_properties = ...` wird verwendet, um einen freien Formtyp für `map` zu definieren, wie z.B. [`HashMap`](https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html) und [`BTreeMap`](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Freie Formtypen erlauben die Verwendung beliebiger Typen in den Map-Werten. Unterstützte Formate sind _`additional_properties`_ und _`
{/* Auto generated, origin file hash:0cd338da7f2e4cf2b5d77a3752808958 */}