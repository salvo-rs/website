# CSRF防御

## CSRFとは？

CSRF（Cross-Site Request Forgery、クロスサイトリクエストフォージェリ）は、攻撃者が認証済みユーザーに意図しない操作を実行させるサイバーセキュリティの脆弱性です。簡単に言えば、攻撃者はユーザーのログイン状態を悪用し、ユーザーになりすまして悪意のあるリクエストを送信します。

## CSRF攻撃の仕組み

攻撃の手順は通常以下の通りです：
1. ユーザーがターゲットサイトAにログインし、認証Cookieを取得
2. ユーザーが悪意のあるサイトBにアクセス
3. サイトB内のコードが自動的にサイトAへリクエストを送信（ユーザーのCookie付き）
4. サイトAは悪意のあるリクエストとユーザー本人の操作を区別できない

## 防御策

SalvoはCSRFミドルウェアを提供し、アプリケーションをこの種の攻撃から保護します：

- フォームに隠しCSRFトークンを追加
- ユーザー送信のリクエストに有効なCSRFトークンが含まれているか検証
- デフォルトでPOST、PATCH、DELETE、PUTリクエストを検証

## SalvoにおけるCSRF実装

`Csrf` は `Handler` を実装した構造体で、内部に `skipper` フィールドを持ち、検証不要なリクエストをスキップ指定できます。デフォルトでは `Method::POST`、`Method::PATCH`、`Method::DELETE`、`Method::PUT` リクエストを検証します。

Salvoは2種類のCSRFトークン保存方式をサポート：

1. **CookieStore**：トークンをCookieに保存し、リクエストヘッダーまたはフォームの `csrf-token` とCookie値の一致を検証
2. **SessionStore**：トークンをSessionに保存（セッションミドルウェアとの併用必須）

_**サンプルコード**_ (cookie store)

import { Tab, Tabs } from '@rspress/core/theme';

<Tabs>
  <Tab label="main.rs">
  ```rust file="<root>/codes/csrf-cookie-store/src/main.rs"
  ```
  </Tab>
  <Tab label="Cargo.toml">
  ```toml file="<root>/codes/csrf-cookie-store/Cargo.toml"
  ```
  </Tab>
</Tabs>

_**サンプルコード**_ (session store)

<Tabs>
  <Tab label="main.rs">
  ```rust file="<root>/codes/csrf-session-store/src/main.rs"
  ```
  </Tab>
  <Tab label="Cargo.toml">
  ```toml file="<root>/codes/csrf-session-store/Cargo.toml"
  ```
  </Tab>
</Tabs>
{/* 本行由工具自动生成,原文哈希值:2eb072bb663695f226b56a34f14cdbb0 */}