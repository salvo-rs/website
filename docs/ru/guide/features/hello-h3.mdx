# Поддержка HTTP/3

Salvo предоставляет поддержку HTTP/3, которую можно включить с помощью функции `quinn`. HTTP/3 основан на протоколе QUIC и предлагает меньшую задержку и лучшую производительность по сравнению с традиционными HTTP/1.1 и HTTP/2, особенно в нестабильных сетевых условиях.

## Включение поддержки HTTP/3

Чтобы включить поддержку HTTP/3 в Salvo, необходимо активировать функцию `quinn` в файле `Cargo.toml`:

```toml
salvo = { workspace = true, features = ["quinn"] }
```

## Сценарии использования HTTP/3

HTTP/3 особенно полезен в следующих случаях:

- Приложения для мобильных устройств и работы в нестабильных сетях
- Приложения реального времени с требованием низкой задержки
- Параллельная загрузка множества мелких файлов
- Приложения, требующие миграции соединений (например, переключение между Wi-Fi и мобильной сетью без разрыва соединения)

## Пример кода

Вот простой пример сервера, поддерживающего одновременно HTTP/3 (QUIC) и HTTPS (TCP):

```rust
use salvo::conn::rustls::{Keycert, RustlsConfig};
use salvo::prelude::*;

// Функция-обработчик, возвращающая "Hello World"
#[handler]
async fn hello() -> &'static str {
    "Hello World"
}

#[tokio::main]
async fn main() {
    // Инициализация системы логирования
    tracing_subscriber::fmt().init();

    // Загрузка TLS-сертификата и приватного ключа из встроенных PEM-файлов
    let cert = include_bytes!("../certs/cert.pem").to_vec();
    let key = include_bytes!("../certs/key.pem").to_vec();

    // Создание маршрутизатора с одним конечным пунктом
    let router = Router::new().get(hello);

    // Настройка TLS с использованием Rustls
    let config = RustlsConfig::new(Keycert::new().cert(cert.as_slice()).key(key.as_slice()));

    // Создание TCP-листенера с TLS-шифрованием на порту 5800
    let listener = TcpListener::new(("0.0.0.0", 5800)).rustls(config.clone());

    // Создание QUIC-листенера и его объединение с TCP-листенером
    let acceptor = QuinnListener::new(config.build_quinn_config().unwrap(), ("0.0.0.0", 5800))
        .join(listener)
        .bind()
        .await;

    // Запуск сервера с поддержкой HTTP/3 (QUIC) и HTTPS (TCP)
    Server::new(acceptor).serve(router).await;
}
```

## Ключевые моменты кода

### Настройка TLS

```rust
// Настройка TLS с использованием Rustls
let config = RustlsConfig::new(Keycert::new().cert(cert.as_slice()).key(key.as_slice()));
```

Поскольку HTTP/3 основан на протоколе QUIC, который требует использования TLS 1.3 для шифрования, необходимо настроить TLS-сертификат и ключ. В Salvo для этого используется `RustlsConfig`.

### Объединение листенеров

```rust
// Создание TCP-листенера с TLS-шифрованием
let listener = TcpListener::new(("0.0.0.0", 5800)).rustls(config.clone());

// Создание QUIC-листенера и его объединение с TCP-листенером
let acceptor = QuinnListener::new(config.build_quinn_config().unwrap(), ("0.0.0.0", 5800))
    .join(listener)
    .bind()
    .await;
```

Этот код является ключевым для обработки HTTP/3 в Salvo. Сначала создается TCP-листенер с поддержкой TLS (для HTTP/1.1 и HTTP/2), затем QUIC-листенер (для HTTP/3). Метод `join` объединяет эти листенеры, позволяя серверу обрабатывать запросы по разным протоколам.

## Запуск примера

Для запуска этого примера потребуются действительный TLS-сертификат и приватный ключ. В среде разработки можно использовать самоподписанные сертификаты. Полный пример кода можно найти в [репозитории Salvo на GitHub](https://github.com/salvo-rs/salvo/tree/main/examples/hello-h3).

Важно отметить, что многие клиенты пока не полностью поддерживают HTTP/3, поэтому одновременная поддержка сервером HTTP/3 и HTTPS является необходимой.

## Важные замечания

1. Для HTTP/3 требуется поддержка TLS 1.3, поэтому необходимо настроить действительный сертификат и ключ.
2. Клиент должен поддерживать протокол HTTP/3 для использования этой функции, в противном случае будет выполнен откат к HTTP/1.1 или HTTP/2.
3. В производственной среде следует использовать сертификаты, подписанные доверенным центром сертификации, а не самоподписанные сертификаты.
{/* 本行由工具自动生成,原文哈希值:b4abbc723f2cb070d8584564bf96ce8a */}