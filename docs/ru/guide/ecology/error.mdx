---
title: Библиотеки обработки ошибок в Rust
---

# Библиотеки обработки ошибок в Rust

- (thiserror)[https://docs.rs/thiserror/latest/thiserror/] предоставляет удобные производные макросы для создания пользовательских типов ошибок.

- (snafu)[https://docs.rs/snafu/latest/snafu/] — это фреймворк для обработки и отчёта об ошибках с контекстом.

- (anyhow)[https://docs.rs/anyhow/latest/anyhow/] — гибкая библиотека для обработки и отчёта об ошибках.

## thiserror vs snafu

### thiserror

thiserror — это лёгкая библиотека, предоставляющая производные макросы для упрощения определения ошибок.

Особенности:
- Лаконичный синтаксис, низкий порог вхождения
- Подходит для создания библиотек типов ошибок и API
- Обычно используется для создания библиотек, предназначенных для других разработчиков

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum DataError {
    #[error("Ошибка базы данных: {0}")]
    DatabaseError(#[from] sqlx::Error),
    
    #[error("Ошибка валидации: {0}")]
    ValidationError(String),
    
    #[error("Запись не найдена")]
    NotFound,
}
```

### snafu

snafu предоставляет более полный фреймворк обработки ошибок, уделяя особое внимание контексту ошибок и цепочкам ошибок.

Особенности:
- Поощряет более точное добавление контекста ошибок через паттерн "селекторов контекста"
- Рекомендует паттерн "одно перечисление ошибок на модуль"
- Поддерживает варианты ошибок в стиле структур и кортежей
- Встроенная поддержка трассировки стека

```rust
use snafu::{Snafu, ResultExt, Backtrace};

#[derive(Debug, Snafu)]
pub enum Error {
    #[snafu(display("Не удалось прочитать файл конфигурации {filename:?}"))]
    ReadConfig {
        filename: String,
        source: std::io::Error,
        backtrace: Backtrace,
    },
    
    // Также можно использовать стиль кортежей
    #[snafu(display("Ошибка ввода-вывода"))]
    Io(#[snafu(source)] std::io::Error, #[snafu(backtrace)] Backtrace),
}

// Пример селектора контекста
fn read_config(path: &str) -> Result<Config, Error> {
    std::fs::read_to_string(path).context(ReadConfigSnafu { filename: path })?;
    // ...
}
```

### Сравнение

| Характеристика | thiserror | snafu |
|----------------|-----------|-------|
| Лаконичность синтаксиса | Более лаконичный | Более многословный |
| Контекст ошибок | Базовая поддержка | Богатый механизм контекста |
| Масштаб проекта | Небольшие и средние проекты | Средние и крупные проекты |
| Строк кода на ошибку | ~2 строки | ~5 строк |
| Организация ошибок | Обычно единое перечисление ошибок | Поощряет перечисления ошибок на уровне модуля |
| Поддержка трассировки стека | Нет встроенной поддержки | Встроенная поддержка |

**Рекомендации по выбору**:
- **Выберите thiserror**, если вам нужны простые и понятные типы ошибок, особенно в библиотеках
- **Выберите snafu**, если вам требуется более структурированная обработка ошибок, особенно в крупных приложениях

## anyhow

anyhow — это библиотека обработки ошибок, отличающаяся от двух предыдущих, она ориентирована на приложения, а не на библиотеки.

Особенности:
- Разработана для обработки ошибок в приложениях, а не в библиотеках
- Предоставляет динамический тип `anyhow::Error`, который может содержать любую ошибку, реализующую трейт `Error`
- Упрощает обработку ошибок из нескольких источников
- Не требует определения пользовательских типов ошибок

```rust
use anyhow::{Context, Result};

fn main() -> Result<()> {
    let config = std::fs::read_to_string("config.json")
        .context("Не удалось прочитать файл конфигурации")?;
        
    let app_config: AppConfig = serde_json::from_str(&config)
        .context("Неверный формат конфигурации")?;
        
    // Используйте Result<T> как псевдоним типа для Result<T, anyhow::Error>
    Ok(())
}
```

**anyhow vs thiserror/snafu**:
- anyhow ориентирована на быструю разработку приложений и обработку ошибок
- thiserror/snafu ориентированы на создание точной иерархии типов ошибок
- anyhow обычно используется в коде приложений
- thiserror/snafu обычно используются в коде библиотек

На практике anyhow и thiserror часто используются вместе: библиотеки используют thiserror для определения точных типов ошибок, а приложения используют anyhow для обработки ошибок из различных источников.
{/* Auto generated, origin file hash:e786d782f2c0d052350def02a332c83f */}