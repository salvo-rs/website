---
title: Альтернативы аллокаторам памяти в Rust
---

# Jemallocator: альтернативный аллокатор памяти jemalloc для Rust

:::tip
Стандартный аллокатор иногда может не освобождать память своевременно. Рекомендуется использовать [jemallocator](https://docs.rs/tikv-jemallocator/latest/tikv_jemallocator/) в качестве глобального аллокатора для замены стандартного.
:::

[jemallocator](https://docs.rs/tikv-jemallocator/latest/tikv_jemallocator/) — это библиотека, связанная с аллокатором памяти jemalloc, предоставляющая тип `Jemalloc`, который реализует API аллокатора и может быть установлен как `#[global_allocator]`.

`tikv-jemallocator` является преемником проекта `jemallocator`. Эти два крейта идентичны, за исключением их названий. Для новых проектов рекомендуется использовать версию `tikv-xxx`.

## Экосистема jemalloc

Экосистема поддержки jemalloc состоит из следующих крейтов:

- **tikv-jemalloc-sys**: Собирает и линкует jemalloc, предоставляя сырые C-привязки к нему.
- **tikv-jemallocator**: Предоставляет тип `Jemalloc`, реализующий трейты `GlobalAlloc` и `Alloc`.
- **tikv-jemalloc-ctl**: Высокоуровневые обёртки для API управления и интроспекции jemalloc (семейство функций `mallctl*()` и `MALLCTL NAMESPACE`).

## Использование

### Добавление зависимостей

Для использования tikv-jemallocator добавьте его в зависимости:

```toml
[dependencies]

[target.'cfg(not(target_env = "msvc"))'.dependencies]
tikv-jemallocator = "0.5"
```

### Установка в качестве глобального аллокатора

Чтобы установить `tikv_jemallocator::Jemalloc` в качестве глобального аллокатора, добавьте следующий код в ваш проект:

```rust
#[cfg(not(target_env = "msvc"))]
use tikv_jemallocator::Jemalloc;

#[cfg(not(target_env = "msvc"))]
#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;
```

Всё готово! После определения этой статической переменной jemalloc будет использоваться для всех выделений памяти, запрашиваемых кодом Rust в рамках одной программы.

## Преимущества

jemalloc — это общая реализация malloc, ориентированная на:

- Уменьшение фрагментации памяти
- Масштабируемость в сценариях с высокой конкурентностью
- Предоставление богатых возможностей интроспекции и управления

Особенно полезен в следующих сценариях:
- Долго работающие приложения
- Задачи с интенсивным использованием памяти
- Высокопроизводительные сервисы, требующие детального управления памятью

## Примечания по совместимости

jemalloc не поддерживает целевую среду MSVC и, следовательно, недоступен при использовании инструментария MSVC в Windows. Именно поэтому в примере кода присутствует условие `cfg(not(target_env = "msvc"))`.
{/* Auto generated, origin file hash:02aa32143bfd3592039f518984bc0bb5 */}