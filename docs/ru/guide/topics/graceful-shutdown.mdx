# Грациозная остановка

Грациозная остановка означает, что при завершении работы сервера соединения не обрываются мгновенно. Вместо этого сервер сначала прекращает принимать новые запросы, давая уже принятым запросам достаточно времени для завершения обработки перед остановкой службы. Такой подход позволяет избежать внезапного прерывания запросов, повышая удобство пользователей и надежность системы.

Salvo предоставляет поддержку грациозной остановки через метод `handle` структуры `Server`, после чего можно вызвать метод `stop_graceful`. После вызова этого метода сервер:

- Прекращает принимать новые соединения
- Ожидает завершения обработки текущих запросов
- По истечении указанного таймаута (если он задан) принудительно закрывает оставшиеся соединения

Вот простой пример:

```rust
use salvo_core::prelude::*;

#[tokio::main]
async fn main() {
    let acceptor = TcpListener::new("127.0.0.1:5800").bind().await;
    let server = Server::new(acceptor);
    let handle = server.handle();

    // Грациозное завершение работы сервера
    tokio::spawn(async move {
        tokio::time::sleep(std::time::Duration::from_secs(60)).await;
        handle.stop_graceful(None);
    });
    server.serve(Router::new()).await;
}
```

В приведенном примере:

- `server.handle()` получает хэндл сервера для управления его жизненным циклом
- `handle.stop_graceful(None)` инициирует процесс грациозной остановки, где `None` означает отсутствие таймаута - сервер будет ждать завершения всех запросов
- Для установки таймаута можно передать `Some(Duration)`, после чего оставшиеся соединения будут принудительно закрыты

Этот подход особенно полезен для приложений, развертываемых в контейнерах или облачных платформах, а также при необходимости "горячего" обновления, чтобы гарантировать, что запросы не будут неожиданно прерваны.
{/* 本行由工具自动生成,原文哈希值:37a3d8a11c033b0d07dca20cf5f3b96b */}