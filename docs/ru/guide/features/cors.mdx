# Управление межсайтовыми запросами

CORS (Cross-Origin Resource Sharing, совместное использование ресурсов между источниками) — это механизм, позволяющий браузеру отправлять запросы к серверам из других источников, преодолевая ограничения политики одинакового источника.

## Что такое политика одинакового источника?

Политика одинакового источника — это функция безопасности браузера, ограничивающая взаимодействие документов или скриптов, загруженных из одного источника, с ресурсами из другого источника. «Одинаковый источник» означает одинаковый протокол, домен и порт.

## Зачем нужен CORS?

CORS необходим, когда фронтенд-приложению требуется доступ к API из другого источника. Например:
- Фронтенд-приложение развернуто на `https://frontend.com`
- API-сервис развернут на `https://api.backend.com`

Без CORS браузер заблокирует доступ фронтенд-приложения к API-сервису.

## Как работает CORS

CORS реализует управление межсайтовым доступом через набор HTTP-заголовков:
- **Простой запрос**: отправляется напрямую, сервер контролирует разрешение через заголовки ответа
- **Предварительный запрос**: браузер сначала отправляет OPTIONS-запрос, чтобы узнать, разрешает ли сервер межсайтовый доступ, и только после получения разрешения отправляет фактический запрос

Поскольку браузер отправляет предварительный OPTIONS-запрос (`Method::OPTIONS`), необходимо добавить обработку таких запросов, поместив CORS-промежуточный слой в `Service`.

## Использование CORS в Salvo

Salvo предоставляет встроенный CORS-промежуточный слой, который легко настраивается и используется. Пример кода:

:::warning
**Внимание**. Промежуточный слой `.hoop(cors)` применяется к `Service`, а не к `Router`.
Это позволяет автоматически обрабатывать предварительные OPTIONS-запросы.
```rust
let cors = Cors::new()
    .allow_origin(["http://127.0.0.1:5800", "http://localhost:5800"])
    .allow_methods(vec![Method::GET, Method::POST, Method::DELETE])
    .allow_headers("authorization")
    .into_handler();

// Настройка маршрутизатора бэкенда с защитой CORS
let router = Router::with_path("hello").post(hello);
let service = Service::new(router).hoop(cors);
```
:::

_**Пример кода**_

import { Tab, Tabs } from '@rspress/core/theme';

<Tabs>
  <Tab label="main.rs">
  ```rust file="<root>/codes/cors/src/main.rs"
  ```
  </Tab>
  <Tab label="Cargo.toml">
  ```toml file="<root>/codes/cors/Cargo.toml"
  ```
  </Tab>
</Tabs>

## Основные параметры конфигурации

CORS-промежуточный слой предоставляет различные параметры конфигурации:

- **Разрешенные источники**: управляет тем, какие домены могут обращаться к ресурсам
- **Разрешенные методы**: указывает разрешенные HTTP-методы (GET, POST и т.д.)
- **Разрешенные заголовки**: указывает разрешенные заголовки запроса
- **Открытые заголовки**: указывает, какие заголовки ответа могут быть доступны клиенту
- **Разрешение учетных данных**: разрешает ли запрос включать cookies и другие учетные данные
- **Время кэширования предварительного запроса**: время кэширования результатов предварительного запроса

Правильная настройка CORS позволяет обеспечить безопасность, одновременно удовлетворяя потребности в межсайтовом доступе.
{/* 本行由工具自动生成,原文哈希值:cf229c3c39be32658130e3590ea819e7 */}